<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Stabilizer ADC management interface"><title>stabilizer::hardware::adc - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-aa0817cf.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="stabilizer" data-themes="" data-resource-suffix="" data-rustdoc-version="1.90.0 (1159e78c4 2025-09-14)" data-channel="1.90.0" data-search-js="search-fa3e91e5.js" data-settings-js="settings-5514c975.js" ><script src="../../../static.files/storage-68b7e25d.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-eebb9057.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-32bb7600.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../stabilizer/index.html">stabilizer</a><span class="version">0.11.0</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module adc</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#design" title="Design">Design</a><ul><li><a href="#starting-data-collection" title="Starting Data Collection">Starting Data Collection</a></li><li><a href="#batch-sizing" title="Batch Sizing">Batch Sizing</a></li></ul></li><li><a href="#note" title="Note">Note</a></li></ul><h3><a href="#structs">Module Items</a></h3><ul class="block"><li><a href="#structs" title="Structs">Structs</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In stabilizer::<wbr>hardware</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../../index.html">stabilizer</a>::<wbr><a href="../index.html">hardware</a></div><h1>Module <span>adc</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/stabilizer/hardware/adc.rs.html#1-392">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Stabilizer ADC management interface</p>
<h2 id="design"><a class="doc-anchor" href="#design">§</a>Design</h2>
<p>Stabilizer ADCs are connected to the MCU via a simplex, SPI-compatible interface. The ADCs
require a setup conversion time after asserting the CSn (convert) signal to generate the ADC
code from the sampled level. Once the setup time has elapsed, the ADC data is clocked out of
MISO. The internal setup time is managed by the SPI peripheral via a CSn setup time parameter
during SPI configuration, which allows offloading the management of the setup time to hardware.</p>
<p>Because of the SPI-compatibility of the ADCs, a single SPI peripheral + DMA is used to automate
the collection of multiple ADC samples without requiring processing by the CPU, which reduces
overhead and provides the CPU with more time for processing-intensive tasks, like DSP.</p>
<p>The automation of sample collection utilizes three DMA streams, the SPI peripheral, and two
timer compare channel for each ADC. One timer comparison channel is configured to generate a
comparison event every time the timer is equal to a specific value. Each comparison then
generates a DMA transfer event to write into the SPI CR1 register to initiate the transfer.
This allows the SPI interface to periodically read a single sample. The other timer comparison
channel is configured to generate a comparison event slightly before the first (~10 timer
cycles). This channel triggers a separate DMA stream to clear the EOT flag within the SPI
peripheral. The EOT flag must be cleared after each transfer or the SPI peripheral will not
properly complete the single conversion. Thus, by using two DMA streams and timer comparison
channels, the SPI can regularly acquire ADC samples.</p>
<p>In order to collect the acquired ADC samples into a RAM buffer, a final DMA transfer is
configured to read from the SPI RX FIFO into RAM. The request for this transfer is connected to
the SPI RX data signal, so the SPI peripheral will request to move data into RAM whenever it is
available. When enough samples have been collected, a transfer-complete interrupt is generated
and the ADC samples are available for processing.</p>
<p>After a complete transfer of a batch of samples, the inactive buffer is available to the
user for processing. The processing must complete before the DMA transfer of the next batch
completes.</p>
<h3 id="starting-data-collection"><a class="doc-anchor" href="#starting-data-collection">§</a>Starting Data Collection</h3>
<p>Because the DMA data collection is automated via timer count comparisons and DMA transfers, the
ADCs can be initialized and configured, but will not begin sampling the external ADCs until the
sampling timer is enabled. As such, the sampling timer should be enabled after all
initialization has completed and immediately before the embedded processing loop begins.</p>
<h3 id="batch-sizing"><a class="doc-anchor" href="#batch-sizing">§</a>Batch Sizing</h3>
<p>The ADCs collect a group of N samples, which is referred to as a batch. The size of the batch
is configured by the user at compile-time to allow for a custom-tailored implementation. Larger
batch sizes generally provide for lower overhead and more processing time per sample, but come
at the expense of increased input -&gt; output latency.</p>
<h2 id="note"><a class="doc-anchor" href="#note">§</a>Note</h2>
<p>While there are two ADCs, only a single ADC is configured to generate transfer-complete
interrupts. This is done because it is assumed that the ADCs will always be sampled
simultaneously. If only a single ADC is used, it must always be ADC0, as ADC1 will not generate
transfer-complete interrupts.</p>
<p>There is a very small amount of latency between sampling of ADCs due to bus matrix priority. As
such, one of the ADCs will be sampled marginally earlier before the other because the DMA
requests are generated simultaneously. This can be avoided by providing a known offset to the
sample DMA requests, which can be completed by setting e.g. ADC0’s comparison to a counter
value of 0 and ADC1’s comparison to a counter value of 1.</p>
<p>In this implementation, double buffer mode DMA transfers are used because the SPI RX FIFOs
have finite depth, FIFO access is slower than AXISRAM access, and because the single
buffer mode DMA disable/enable and buffer update sequence is slow.</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.Adc0Input.html" title="struct stabilizer::hardware::adc::Adc0Input">Adc0<wbr>Input</a></dt><dd>Represents data associated with ADC.</dd><dt><a class="struct" href="struct.Adc1Input.html" title="struct stabilizer::hardware::adc::Adc1Input">Adc1<wbr>Input</a></dt><dd>Represents data associated with ADC.</dd></dl></section></div></main></body></html>